# Allow traffic to sealed-secrets controller for kubeseal CLI
# The Kubernetes API server proxy connects directly to pod IPs,
# bypassing the Service, so we need to allow ingress from the
# API server / node network to the sealed-secrets pod.
#
# Note: The 10.0.0.0/8 CIDR is broad but appropriate for homelab environments.
# For production, restrict to specific node IP ranges.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-sealed-secrets
  namespace: flux-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: sealed-secrets
  policyTypes:
    - Ingress
  ingress:
    # Allow from API server / control plane nodes
    # RKE2 typically runs API server on nodes, so allow from node network
    - from:
        - ipBlock:
            cidr: 10.0.0.0/8  # Broad range to cover node IPs - adjust if needed
      ports:
        - protocol: TCP
          port: 8080
    # Allow from within the cluster (pod network)
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8080
    # Allow metrics scraping on port 8081
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 8081
