apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-capabilities
  annotations:
    policies.kyverno.io/title: Restrict Linux Capabilities
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: >-
      Containers should drop all capabilities and only add back those that
      are required. This policy validates that containers do not add
      dangerous capabilities and that they drop ALL capabilities by default.
      Safe capabilities (CHOWN, DAC_OVERRIDE, FOWNER, FSETID, KILL, SETGID,
      SETUID, SETPCAP, NET_BIND_SERVICE, SYS_CHROOT, SETFCAP) are allowed.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-drop-all
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-node-lease
                - kube-public
                - flux-system
                - kyverno
                - longhorn-system
                - storage
                - monitoring
                - cert-manager
      validate:
        message: >-
          Containers must drop all capabilities. Add 'ALL' to
          spec.containers[*].securityContext.capabilities.drop.
        foreach:
          - list: "request.object.spec.containers"
            deny:
              conditions:
                all:
                  - key: "ALL"
                    operator: AnyNotIn
                    value: "{{ element.securityContext.capabilities.drop || `[]` }}"
          - list: "request.object.spec.initContainers || []"
            deny:
              conditions:
                all:
                  - key: "ALL"
                    operator: AnyNotIn
                    value: "{{ element.securityContext.capabilities.drop || `[]` }}"
          - list: "request.object.spec.ephemeralContainers || []"
            deny:
              conditions:
                all:
                  - key: "ALL"
                    operator: AnyNotIn
                    value: "{{ element.securityContext.capabilities.drop || `[]` }}"
    - name: restrict-added-capabilities
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-node-lease
                - kube-public
                - flux-system
                - kyverno
                - longhorn-system
                - storage
                - monitoring
                - cert-manager
      validate:
        message: >-
          Only safe capabilities may be added. Allowed: CHOWN, DAC_OVERRIDE,
          FOWNER, FSETID, KILL, SETGID, SETUID, SETPCAP, NET_BIND_SERVICE,
          SYS_CHROOT, SETFCAP.
        # AllNotIn: deny if ALL capabilities in the add list are NOT in the allowed values
        foreach:
          - list: "request.object.spec.containers"
            deny:
              conditions:
                any:
                  - key: "{{ element.securityContext.capabilities.add || `[]` }}"
                    operator: AllNotIn
                    value:
                      - CHOWN
                      - DAC_OVERRIDE
                      - FOWNER
                      - FSETID
                      - KILL
                      - SETGID
                      - SETUID
                      - SETPCAP
                      - NET_BIND_SERVICE
                      - SYS_CHROOT
                      - SETFCAP
          - list: "request.object.spec.initContainers || []"
            deny:
              conditions:
                any:
                  - key: "{{ element.securityContext.capabilities.add || `[]` }}"
                    operator: AllNotIn
                    value:
                      - CHOWN
                      - DAC_OVERRIDE
                      - FOWNER
                      - FSETID
                      - KILL
                      - SETGID
                      - SETUID
                      - SETPCAP
                      - NET_BIND_SERVICE
                      - SYS_CHROOT
                      - SETFCAP
          - list: "request.object.spec.ephemeralContainers || []"
            deny:
              conditions:
                any:
                  - key: "{{ element.securityContext.capabilities.add || `[]` }}"
                    operator: AllNotIn
                    value:
                      - CHOWN
                      - DAC_OVERRIDE
                      - FOWNER
                      - FSETID
                      - KILL
                      - SETGID
                      - SETUID
                      - SETPCAP
                      - NET_BIND_SERVICE
                      - SYS_CHROOT
                      - SETFCAP
