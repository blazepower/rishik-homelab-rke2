apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-bootstrap-script
  namespace: kube-system
data:
  gpu-bootstrap.sh: |
    #!/bin/bash
    set -o pipefail

    BOOTSTRAP_VERSION="v2"
    MARKER_FILE="/host/var/lib/gpu-bootstrap.done"
    MODULES_CONF="/host/etc/modules-load.d/intel-gpu.conf"
    MODPROBE_CONF="/host/etc/modprobe.d/i915.conf"
    SIMPLEDRM_BLACKLIST="/host/etc/modprobe.d/blacklist-simpledrm.conf"

    log() {
      echo "[gpu-bootstrap] $1"
    }

    # Check idempotency marker with version
    if [ -f "$MARKER_FILE" ]; then
      CURRENT_VERSION=$(cat "$MARKER_FILE" 2>/dev/null)
      if [ "$CURRENT_VERSION" = "$BOOTSTRAP_VERSION" ]; then
        log "Bootstrap already completed (version: $BOOTSTRAP_VERSION). Marker exists at $MARKER_FILE"
        log "Keeping container alive for inspection..."
        sleep infinity
      else
        log "Bootstrap version mismatch: found '$CURRENT_VERSION', expected '$BOOTSTRAP_VERSION'. Re-running bootstrap..."
      fi
    fi

    log "Starting Intel GPU bootstrap (version: $BOOTSTRAP_VERSION)..."

    # Blacklist simpledrm module to prevent /dev/dri/by-path conflicts with Intel GPU device plugin
    log "Creating simpledrm blacklist at $SIMPLEDRM_BLACKLIST..."
    cat > "$SIMPLEDRM_BLACKLIST" <<EOF
    # Blacklist simpledrm to prevent /dev/dri/by-path conflicts with Intel GPU device plugin
    blacklist simpledrm
    EOF
    chmod 644 "$SIMPLEDRM_BLACKLIST"
    log "Created $SIMPLEDRM_BLACKLIST"

    # Attempt to unload simpledrm if currently loaded
    if chroot /host lsmod | grep -q "^simpledrm"; then
      log "simpledrm module is loaded, attempting to unload..."
      if chroot /host modprobe -r simpledrm 2>/dev/null; then
        log "Successfully unloaded simpledrm module"
      else
        log "Warning: Could not unload simpledrm module (in use). Will take effect after reboot."
      fi
    else
      log "simpledrm module is not loaded"
    fi

    # Update initramfs to apply blacklist persistently
    log "Updating initramfs to apply module blacklist..."
    if chroot /host update-initramfs -u 2>/dev/null; then
      log "Successfully updated initramfs"
    else
      log "Warning: Could not update initramfs. Blacklist may not persist after reboot."
    fi

    # Create modules-load.d config for Intel GPU
    if [ ! -f "$MODULES_CONF" ]; then
      log "Creating $MODULES_CONF..."
      cat > "$MODULES_CONF" <<EOF
    i915
    drm
    drm_kms_helper
    video
    EOF
      log "Created $MODULES_CONF"
    else
      log "$MODULES_CONF already exists, skipping..."
    fi

    # Create modprobe.d config for i915 GuC/HuC
    if [ ! -f "$MODPROBE_CONF" ]; then
      log "Creating $MODPROBE_CONF..."
      cat > "$MODPROBE_CONF" <<EOF
    options i915 enable_guc=3
    EOF
      log "Created $MODPROBE_CONF"
    else
      log "$MODPROBE_CONF already exists, skipping..."
    fi

    # Load kernel modules immediately on host
    log "Loading kernel modules on host..."
    for mod in i915 drm drm_kms_helper video; do
      if chroot /host modprobe "$mod" 2>/dev/null; then
        log "Loaded module: $mod"
      else
        log "Warning: Could not load module $mod (may already be loaded or not available)"
      fi
    done

    # Install Intel GPU packages on host via chroot
    log "Installing Intel GPU packages on host..."
    chroot /host /bin/bash -c '
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y || echo "[gpu-bootstrap] Warning: apt-get update failed, continuing..."
      apt-get install -y --no-install-recommends \
        intel-media-va-driver-non-free \
        intel-opencl-icd \
        libva-dev \
        vainfo || echo "[gpu-bootstrap] Warning: Some packages may have failed to install"
    ' || log "Warning: chroot apt install encountered issues, continuing..."

    # Create idempotency marker with version
    log "Creating idempotency marker at $MARKER_FILE with version $BOOTSTRAP_VERSION..."
    echo "$BOOTSTRAP_VERSION" > "$MARKER_FILE"

    log "Intel GPU bootstrap completed successfully!"
    log "Keeping container alive for inspection..."
    sleep infinity
