apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-bootstrap-script
  namespace: kube-system
data:
  gpu-bootstrap.sh: |
    #!/bin/bash
    set -o pipefail

    MARKER_FILE="/host/var/lib/gpu-bootstrap-v3.done"
    MODULES_CONF="/host/etc/modules-load.d/intel-gpu.conf"
    MODPROBE_CONF="/host/etc/modprobe.d/i915.conf"
    GRUB_DEFAULT="/host/etc/default/grub"

    log() {
      echo "[gpu-bootstrap] $1"
    }

    # Check idempotency marker
    if [ -f "$MARKER_FILE" ]; then
      log "Bootstrap already completed. Marker exists at $MARKER_FILE"
      log "Keeping container alive for inspection..."
      sleep infinity
    fi

    log "Starting Intel GPU bootstrap..."

    # Configure GRUB to blacklist simpledrm via kernel boot parameter
    log "Checking GRUB configuration for simpledrm blacklist..."
    if [ -f "$GRUB_DEFAULT" ]; then
      # Check if module_blacklist=simpledrm is already in GRUB_CMDLINE_LINUX_DEFAULT line
      # Use word boundary matching to avoid matching partial strings like simpledrmfoo
      if grep -E '^GRUB_CMDLINE_LINUX_DEFAULT=.*module_blacklist=simpledrm([[:space:]]|"|'"'"'|$)' "$GRUB_DEFAULT" >/dev/null 2>&1; then
        log "GRUB already configured to blacklist simpledrm, skipping..."
      else
        log "Adding module_blacklist=simpledrm to GRUB configuration..."
        # Backup the original file
        cp "$GRUB_DEFAULT" "${GRUB_DEFAULT}.bak"
        # Append module_blacklist=simpledrm to GRUB_CMDLINE_LINUX_DEFAULT
        # Handle both double-quoted and single-quoted values
        # Use sed to trim trailing space before closing quote and add the parameter
        if grep -E '^GRUB_CMDLINE_LINUX_DEFAULT="[^"]*"' "$GRUB_DEFAULT" >/dev/null 2>&1; then
          sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*[^ ]\) *"/GRUB_CMDLINE_LINUX_DEFAULT="\1 module_blacklist=simpledrm"/' "$GRUB_DEFAULT"
          # Handle empty value case
          sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=""/GRUB_CMDLINE_LINUX_DEFAULT="module_blacklist=simpledrm"/' "$GRUB_DEFAULT"
        elif grep -E "^GRUB_CMDLINE_LINUX_DEFAULT='[^']*'" "$GRUB_DEFAULT" >/dev/null 2>&1; then
          sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT='\\([^']*[^ ]\\) *'/GRUB_CMDLINE_LINUX_DEFAULT='\\1 module_blacklist=simpledrm'/" "$GRUB_DEFAULT"
          # Handle empty value case
          sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=''/GRUB_CMDLINE_LINUX_DEFAULT='module_blacklist=simpledrm'/" "$GRUB_DEFAULT"
        else
          log "Warning: Could not parse GRUB_CMDLINE_LINUX_DEFAULT format, skipping"
        fi
        # Validate that module_blacklist=simpledrm was added successfully
        if grep -qE '^GRUB_CMDLINE_LINUX_DEFAULT=.*module_blacklist=simpledrm([[:space:]]|"|'"'"'|$)' "$GRUB_DEFAULT"; then
          log "Verified: module_blacklist=simpledrm was added to GRUB configuration"
        else
          log "Error: Failed to add module_blacklist=simpledrm to GRUB configuration"
          # Optionally restore backup
          mv "${GRUB_DEFAULT}.bak" "$GRUB_DEFAULT"
          exit 1
        fi
        log "Updated GRUB_CMDLINE_LINUX_DEFAULT with module_blacklist=simpledrm"
        # Run update-grub to apply changes
        log "Running update-grub to apply changes..."
        chroot /host update-grub 2>&1 || log "Warning: update-grub encountered issues"
        log "GRUB configuration updated. Reboot required for simpledrm blacklist to take effect."
      fi
    else
      log "Warning: $GRUB_DEFAULT not found, skipping GRUB configuration"
    fi

    # Attempt to unload simpledrm if currently loaded
    log "Attempting to unload simpledrm module..."
    if chroot /host modprobe -r simpledrm 2>/dev/null; then
      log "Successfully unloaded simpledrm module"
    else
      log "Note: simpledrm in use or not loaded, will be blacklisted after reboot"
    fi

    # Create modules-load.d config for Intel GPU
    if [ ! -f "$MODULES_CONF" ]; then
      log "Creating $MODULES_CONF..."
      cat > "$MODULES_CONF" <<EOF
    i915
    drm
    drm_kms_helper
    video
    EOF
      log "Created $MODULES_CONF"
    else
      log "$MODULES_CONF already exists, skipping..."
    fi

    # Create modprobe.d config for i915 GuC/HuC
    if [ ! -f "$MODPROBE_CONF" ]; then
      log "Creating $MODPROBE_CONF..."
      cat > "$MODPROBE_CONF" <<EOF
    options i915 enable_guc=3
    EOF
      log "Created $MODPROBE_CONF"
    else
      log "$MODPROBE_CONF already exists, skipping..."
    fi

    # Load kernel modules immediately on host
    log "Loading kernel modules on host..."
    for mod in i915 drm drm_kms_helper video; do
      if chroot /host modprobe "$mod" 2>/dev/null; then
        log "Loaded module: $mod"
      else
        log "Warning: Could not load module $mod (may already be loaded or not available)"
      fi
    done

    # Install Intel GPU packages on host via chroot
    log "Installing Intel GPU packages on host..."
    chroot /host /bin/bash -c '
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y || echo "[gpu-bootstrap] Warning: apt-get update failed, continuing..."
      apt-get install -y --no-install-recommends \
        intel-media-va-driver-non-free \
        intel-opencl-icd \
        libva-dev \
        vainfo || echo "[gpu-bootstrap] Warning: Some packages may have failed to install"
    ' || log "Warning: chroot apt install encountered issues, continuing..."

    # Create idempotency marker
    log "Creating idempotency marker at $MARKER_FILE..."
    touch "$MARKER_FILE"

    log "Intel GPU bootstrap completed successfully!"
    log "Keeping container alive for inspection..."
    sleep infinity
