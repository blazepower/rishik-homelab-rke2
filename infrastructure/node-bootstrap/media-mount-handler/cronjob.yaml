---
# CronJob that checks if media-dependent pods have working mounts
# Runs every 5 minutes and restarts pods if media mount is broken
apiVersion: batch/v1
kind: CronJob
metadata:
  name: media-mount-handler
  namespace: kube-system
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 300
      template:
        spec:
          serviceAccountName: media-mount-handler
          restartPolicy: OnFailure
          containers:
            - name: handler
              image: docker.io/alpine/k8s:1.33.0
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
              command:
                - /bin/sh
                - -c
                - |
                  set -eu

                  log() {
                    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
                  }

                  # Check if a pod can see media directory content
                  check_media_mount() {
                    app_label="$1"
                    container="$2"
                    workload_type="$3"
                    workload_name="$4"

                    pod_name=$(kubectl get pods -n media -l "app.kubernetes.io/name=$app_label" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

                    if [ -z "$pod_name" ]; then
                      log "$app_label pod not found, skipping"
                      return 0
                    fi

                    content=$(kubectl exec -n media "$pod_name" -c "$container" -- ls /media 2>/dev/null || echo "")

                    if [ -z "$content" ]; then
                      log "WARNING: $app_label media mount empty, restarting..."
                      kubectl rollout restart "$workload_type" -n media "$workload_name"
                      return 1
                    fi

                    log "$app_label media mount OK"
                    return 0
                  }

                  main() {
                    log "Media mount handler starting..."

                    check_media_mount "plex-media-server" "plex-plex-media-server-pms" "statefulset" "plex-plex-media-server"
                    check_media_mount "sabnzbd" "sabnzbd" "deployment" "sabnzbd"
                    check_media_mount "qbittorrent" "app" "deployment" "qbittorrent"
                    check_media_mount "radarr" "radarr" "deployment" "radarr"
                    check_media_mount "sonarr" "sonarr" "deployment" "sonarr"

                    log "Media mount handler complete"
                  }

                  main
