apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: rke2-node-bootstrap-iscsi
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: rke2-node-bootstrap-iscsi
  template:
    metadata:
      labels:
        app: rke2-node-bootstrap-iscsi
    spec:
      hostPID: true
      tolerations:
        - operator: Exists
      containers:
        - name: installer
          image: ubuntu:22.04
          securityContext:
            privileged: true
          command:
            - /bin/bash
            - -c
            - |
              mkdir -p /host/etc/rancher/rke2/pre-node.d
              cp /scripts/iscsi-bootstrap.sh /host/etc/rancher/rke2/pre-node.d/iscsi-bootstrap.sh
              chmod +x /host/etc/rancher/rke2/pre-node.d/iscsi-bootstrap.sh
              echo "[BOOTSTRAP] iscsi script written to host"
              sleep infinity
          volumeMounts:
            - name: host-root
              mountPath: /host
            - name: script-files
              mountPath: /scripts
      volumes:
        - name: host-root
          hostPath:
            path: /
        - name: script-files
          configMap:
            name: iscsi-bootstrap-cm
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: iscsi-bootstrap-cm
  namespace: kube-system
data:
  iscsi-bootstrap.sh: |
    #!/bin/bash
    set -e
    echo "[RKE2 BOOTSTRAP] Installing open-iscsi..."
    if ! dpkg -s open-iscsi >/dev/null 2>&1; then
      apt-get update -y
      apt-get install -y open-iscsi
    fi
    systemctl enable iscsid
    systemctl start iscsid
    echo "[RKE2 BOOTSTRAP] open-iscsi installation complete."
